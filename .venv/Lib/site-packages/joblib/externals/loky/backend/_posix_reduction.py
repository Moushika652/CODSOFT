###############################################################################
# Extra reducers for Unix based system and connections objects
#
# author: Thomas Moreau and Olivier Grisel
#
# adapted from multiprocessing/reduction.py (17/02/2017)
#  * Add adapted reduction for LokyProcesses and socket/Connection
#
import os
import socket
import _socket
from multiprocessing.connection import Connection
from multiprocessing.context import get_spawning_popen

from .reduction import register #type: ignore

HAVE_SEND_HANDLE = (
    hasattr(socket, "CMSG_LEN")
    and hasattr(socket, "SCM_RIGHTS")
    and hasattr(socket.socket, "sendmsg")
)


def _mk_inheritable(fd): #type: ignore
    os.set_inheritable(fd, True) #type: ignore
    return fd #type: ignore


def DupFd(fd): #type: ignore
    """Return a wrapper for an fd."""
    popen_obj = get_spawning_popen()
    if popen_obj is not None:
        return popen_obj.DupFd(popen_obj.duplicate_for_child(fd))
    elif HAVE_SEND_HANDLE:
        from multiprocessing import resource_sharer

        return resource_sharer.DupFd(fd) #type: ignore
    else:
        raise TypeError(
            "Cannot pickle connection object. This object can only be "
            "passed when spawning a new process"
        )


def _reduce_socket(s): #type: ignore
    df = DupFd(s.fileno()) #type: ignore
    return _rebuild_socket, (df, s.family, s.type, s.proto) #type: ignore


def _rebuild_socket(df, family, type, proto): #type: ignore
    fd = df.detach() #type: ignore
    return socket.fromfd(fd, family, type, proto) #type: ignore


def rebuild_connection(df, readable, writable): #type: ignore
    fd = df.detach() #type: ignore
    return Connection(fd, readable, writable) #type: ignore


def reduce_connection(conn): #type: ignore
    df = DupFd(conn.fileno()) #type: ignore
    return rebuild_connection, (df, conn.readable, conn.writable) #type: ignore


register(socket.socket, _reduce_socket)
register(_socket.socket, _reduce_socket)
register(Connection, reduce_connection)
