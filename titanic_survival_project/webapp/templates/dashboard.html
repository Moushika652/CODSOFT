<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{ app_name }} - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
      /* override fonts and sizing to Times New Roman */
      body { font-family: "Times New Roman", Times, serif; font-size: 18px; }
      .page-title { font-size: 2.4rem; }
      h2 { font-family: "Times New Roman", Times, serif; font-size: 1.6rem; }

      /* dashboard grid: ensure left alignment so chart sits on left */
      .dashboard-grid {
          display: flex;
          gap: 20px;
          align-items: flex-start;
          justify-content: flex-start;
          flex-wrap: wrap;
      }

      /* left column (chart) alignment and sizing */
      .dashboard-grid .panel.summary {
          flex: 0 0 360px;
          max-width: 100%;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
      }
      #survivalChart {
          width: 100% !important;
          height: auto !important;
          max-width: 360px;
          margin: 0;
          align-self: flex-start;
      }

      /* increase meta and control font sizes */
      .meta, .btn, .nav-links, .brand { font-size: 1.05rem; font-family: "Times New Roman", Times, serif; }

      @media (max-width: 640px) {
          .dashboard-grid { flex-direction: column; }
          #survivalChart { max-width: 100%; }
      }

      .stats { display:flex; gap:1rem; align-items:center; margin:1rem 0; }
      .stat { padding:0.75rem 1rem; border-radius:6px; background:#f5f5f5; }
      .stat .num { font-size:1.25rem; font-weight:700; }
      .stat .sub { color:#555; font-size:0.9rem; }
    </style>
  </head>
  <body class="wrap" style="background:var(--bg-2);">
    <header class="page-header">
        <h1 class="page-title">{{ page_title or "Titanic Lifeboat Prediction" }}</h1>
        {% if page_description %}
            <p class="page-description" style="margin:0.25rem 0 0; font-size:0.95rem;">{{ page_description }}</p>
        {% endif %}
    </header>

    <div class="card" role="main">
      <header class="site-header">
        <div class="brand">Titanic Lifeboat Prediction</div>
        <div class="nav-links">
          <span class="user-pill">{{ session.get('username') or 'Guest' }}</span>
          <a href="/download" class="btn btn-primary">Download CSV</a>
          <a href="/logout" class="btn btn-danger">Logout</a>
        </div>
      </header>

      <h2 style="margin-top:0; font-family: 'Roboto Slab', serif;">Predictions Dashboard</h2>
      <p class="meta"><strong>Dataset:</strong> Titanic passenger data. This app displays model predictions for demonstration.</p>
      <p class="meta"><strong>About these results:</strong> This dashboard groups model predictions into "Survived" and "Not survived" (uses `PredictedProb` when available; default threshold is {{ threshold_used }}). Treat these results as illustrative.</p>
      <p class="meta"><strong>Counts:</strong> Survived: {{ survived_count }} &nbsp; | &nbsp; Not survived: {{ not_survived_count }}</p>
      <p class="meta"><strong>Percentages:</strong> Survived: {{ survived_percent }}% &nbsp; | &nbsp; Not survived: {{ not_survived_percent }}% &nbsp; | &nbsp; Total: {{ total }}</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if message %}
        <p>{{ message }}</p>
      {% else %}
      <div class="dashboard-grid">
        <div class="panel summary">
          <h3 style="margin:0 0 8px 0;">Survival Summary</h3>
          <canvas id="survivalChart" width="300" height="300"></canvas>
          <div style="margin-top:12px;">
            <!-- 'By group' table removed per request -->
            {% if inferred_sex_count and inferred_sex_count > 0 %}
              <p class="meta">Inferred Sex for <strong>{{ inferred_sex_count }}</strong> rows from `Name`.</p>
            {% endif %}
          </div>
        </div>

        <div class="actions">
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a href="/survived" class="btn btn-success" style="flex:1; min-width:180px">View Survived ({{ survived_count }})</a>
            <a href="/not_survived" class="btn btn-danger" style="flex:1; min-width:180px">View Not survived ({{ not_survived_count }})</a>
            {% if sex_col or age_col %}
              {# removed male/female buttons per request #}
            {% endif %}
          </div>

          <!-- moved counts here so they appear below the buttons -->
          <p class="meta" style="margin-top:12px;">
            Survived: <strong>{{ survived_count }}</strong> ({{ survived_percent }}%)<br/>
            Not survived: <strong>{{ not_survived_count }}</strong> ({{ not_survived_percent }}%)
          </p>

          <p style="margin:6px 0 0 0; color:#333;">Click a button to view the full dataset for each group on a separate page.</p>
        </div>
      </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
          (function(){
            // render pie chart
            try {
              const ctx = document.getElementById('survivalChart');
              if (ctx) {
                const data = {
                  labels: ['Survived', 'Not survived'],
                  datasets: [{
                    data: [parseInt('{{ survived_count | default(0) }}'), parseInt('{{ not_survived_count | default(0) }}')], 
                    backgroundColor: ['#2ecc71', '#e74c3c']
                  }]
                };
                new Chart(ctx, { type: 'pie', data: data, options: { responsive: true } });
              }
            } catch (err) { console.warn('Chart init failed', err); }

            // optionally scroll dashboard into view (show chart/actions)
            try {
              const grid = document.querySelector('.dashboard-grid');
              if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (e) { /* ignore */ }
          })();
        </script>
  </body>
</html>
