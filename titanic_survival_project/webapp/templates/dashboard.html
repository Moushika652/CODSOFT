<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Predictions Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto+Slab:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body class="wrap" style="background:var(--bg-2);">
    <div class="card" role="main">
      <header class="site-header">
        <div class="brand">Titanic Predictions</div>
        <div class="nav-links">
          <span class="user-pill">{{ session.get('username') or 'Guest' }}</span>
          <a href="/download" class="btn btn-primary">Download CSV</a>
          <a href="/logout" class="btn btn-danger">Logout</a>
        </div>
      </header>

      <h2 style="margin-top:0; font-family: 'Roboto Slab', serif;">Predictions Dashboard</h2>
      <p class="meta"><strong>Dataset:</strong> Titanic passenger data. This app displays model predictions for demonstration.</p>
      <p class="meta"><strong>About these results:</strong> This dashboard groups model predictions into "Survived" and "Not survived" (uses `PredictedProb` when available; default threshold is 0.9). Treat these results as illustrative.</p>
      {% if threshold_used is not none %}
      <p class="meta"><strong>Threshold:</strong> {{ threshold_used }}{% if achieved_accuracy is not none %} &mdash; Achieved accuracy: {{ achieved_accuracy }}{% endif %}</p>
      {% endif %}
      <p class="meta"><strong>Counts:</strong> Survived: {{ survived_count }} &nbsp; | &nbsp; Not survived: {{ not_survived_count }}</p>
      {% if current_user %}
      <form method="post" action="{{ url_for('enrich_dataset') }}" style="margin:6px 0;">
        <button type="submit" class="btn btn-primary">Save enriched dataset (add Sex)</button>
      </form>
      {% endif %}
      <p class="meta"><strong>Percentages:</strong> Survived: {{ survived_percent }}% &nbsp; | &nbsp; Not survived: {{ not_survived_percent }}% &nbsp; | &nbsp; Total: {{ total_count }}</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if message %}
        <p>{{ message }}</p>
      {% else %}
      <div class="dashboard-grid">
        <div class="panel summary">
          <h3 style="margin:0 0 8px 0;">Survival Summary</h3>
          <canvas id="survivalChart" width="300" height="300"></canvas>
          <p class="meta">Survived: <strong>{{ survived_count }}</strong> ({{ survived_percent }}%)<br/>Not survived: <strong>{{ not_survived_count }}</strong> ({{ not_survived_percent }}%)</p>
          <div style="margin-top:12px;">
            <!-- 'By group' table removed per request -->
            {% if inferred_sex_count and inferred_sex_count > 0 %}
              <p class="meta">Inferred Sex for <strong>{{ inferred_sex_count }}</strong> rows from `Name`.</p>
            {% endif %}
          </div>
        </div>

        <div class="actions">
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a href="/survived" class="btn btn-success" style="flex:1; min-width:180px">View Survived ({{ survived_count }})</a>
            <a href="/not_survived" class="btn btn-danger" style="flex:1; min-width:180px">View Not survived ({{ not_survived_count }})</a>
            {% if sex_col or age_col %}
                {# removed male/female buttons per request #}
              {% if age_col %}
                <a href="/survived?sex=child" class="btn" style="background:#f59e0b;">Survived — Child ({{ survived_child }})</a>
                <a href="/not_survived?sex=child" class="btn" style="background:#f59e0b;">Not survived — Child ({{ not_survived_child }})</a>
              {% endif %}
            {% endif %}
          </div>
          <p style="margin:6px 0 0 0; color:#333;">Click a button to view the full dataset for each group on a separate page.</p>
        </div>
      </div>
      {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function() {
        const ctx = document.getElementById('survivalChart');
        if (!ctx) return;
        const data = {
          labels: ['Survived', 'Not survived'],
          datasets: [{
            data: [{{ survived_count }}, {{ not_survived_count }}],
            backgroundColor: ['#2ecc71', '#e74c3c']
          }]
        };
        new Chart(ctx, { type: 'pie', data: data, options: { responsive: true } });
      })();
    </script>
  </body>
</html>
